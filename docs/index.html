<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AniManga Ranker – PyScript Edition</title>
  <!-- Load PyScript's updated core CSS and JS from the official CDN -->
  <link rel="stylesheet" href="https://pyscript.net/latest/core.css" />
  <script defer src="https://pyscript.net/latest/core.js"></script>
  <style>
    /* Basic styling – similar in spirit to your Tkinter colors */
    body {
      background-color: #2f2f2f;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #3f3f3f;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    input, button, label {
      font-size: 16px;
      margin: 5px;
      padding: 5px;
    }
    button {
      cursor: pointer;
    }
    #progress {
      margin: 10px 0;
    }
    #comparison {
      margin-top: 20px;
    }
    #instruction {
      white-space: pre-wrap;
      margin-bottom: 20px;
      font-size: 18px;
      text-align: center;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AniManga Ranker</h1>
    
    <!-- Setup Section -->
    <div id="setup">
      <label for="username">AniList Username:</label>
      <input type="text" id="username" placeholder="Enter username" />
      <br>
      <!-- Options as checkboxes -->
      <label><input type="checkbox" id="completed" checked /> Completed</label>
      <label><input type="checkbox" id="watching" /> Watching/Reading</label>
      <label><input type="checkbox" id="paused" /> Paused</label>
      <label><input type="checkbox" id="dropped" /> Dropped</label>
      <br>
      <button id="fetchAnime">Fetch Anime List</button>
      <button id="fetchManga">Fetch Manga List</button>
    </div>
    
    <!-- Progress message -->
    <div id="progress"></div>
    
    <!-- Comparison Section (initially hidden) -->
    <div id="comparison" style="display: none;">
      <p id="instruction">Comparison instructions will appear here.</p>
      <button id="newWins">NEW wins</button>
      <button id="candidateWins">Candidate wins</button>
    </div>
    
    <!-- Final results Section (initially hidden) -->
    <div id="results" style="display: none;">
      <h2>Final Ranking (Best to Worst):</h2>
      <ol id="resultsList"></ol>
    </div>
  </div>
  
  <!-- PyScript code block -->
  <py-script>
import asyncio
import json, random
from js import document, fetch

# Global state variables
ANILIST_API_URL = "https://graphql.anilist.co"
unsorted_list = []  # List of media entries: (id, title, score)
sorted_list = []
current_index = 0  # Points to the next item to be sorted

# --- Helper functions ---
def get_el(id):
    return document.getElementById(id)

def update_progress(text):
    get_el("progress").innerHTML = text

def show_section(id, show=True):
    get_el(id).style.display = "block" if show else "none"

# --- Fetch AniList Data Using GraphQL ---
async def fetch_user_list(username, media_type):
    # Build list of statuses from checkbox values.
    statuses = []
    if get_el("completed").checked:
        statuses.append("COMPLETED")
    if get_el("watching").checked:
        statuses.append("CURRENT" if media_type == "ANIME" else "READING")
    if get_el("paused").checked:
        statuses.append("PAUSED")
    if get_el("dropped").checked:
        statuses.append("DROPPED")
    if not statuses:
        update_progress("No list statuses selected!")
        return []
    
    results = []
    for status in statuses:
        query = f'''
        query ($name: String) {{
          MediaListCollection(userName: $name, type: {media_type}, status: {status}) {{
            lists {{
              entries {{
                score
                media {{
                  id
                  title {{ english romaji }}
                }}
              }}
            }}
          }}
        }}
        '''
        payload = {"query": query, "variables": {"name": username}}
        response = await fetch(ANILIST_API_URL, {
            "method": "POST",
            "headers": {"Content-Type": "application/json", "Accept": "application/json"},
            "body": json.dumps(payload)
        })
        data = await response.json()
        lists = data.get("data", {}).get("MediaListCollection", {}).get("lists", [])
        seen = set()
        for lst in lists:
            for entry in lst.get("entries", []):
                media = entry.get("media")
                if media and media.get("id") not in seen:
                    seen.add(media.get("id"))
                    title = (media.get("title", {}).get("english") or
                             media.get("title", {}).get("romaji") or "Unknown")
                    score = entry.get("score", 0)
                    results.append((media.get("id"), title, score))
    # Sort by score in descending order
    results.sort(key=lambda x: x[2], reverse=True)
    return results

# --- Initialize Tournament ---
def init_tournament(items):
    global unsorted_list, sorted_list, current_index
    unsorted_list = items
    if not items:
        update_progress("No items found!")
        return
    sorted_list = [items[0]]
    current_index = 1
    update_progress(f"Fetched {len(items)} items. Starting tournament...")
    show_section("setup", False)
    show_section("comparison", True)
    update_comparison()

# --- Update the Comparison UI ---
def update_comparison():
    if current_index >= len(unsorted_list):
        show_final_results()
        return
    new_item = unsorted_list[current_index]
    candidate = sorted_list[-1]
    get_el("instruction").innerHTML = f"Compare: {new_item[1]} vs. {candidate[1]}"

# --- Handle Comparison Outcome ---
def handle_comparison(new_item_wins):
    global current_index
    new_item = unsorted_list[current_index]
    if new_item_wins:
        sorted_list.insert(0, new_item)
    else:
        sorted_list.append(new_item)
    current_index += 1
    update_progress(f"Processed {current_index} of {len(unsorted_list)} items.")
    update_comparison()

# --- Show Final Tournament Results ---
def show_final_results():
    show_section("comparison", False)
    show_section("results", True)
    resultsList = get_el("resultsList")
    resultsList.innerHTML = ""
    for idx, item in enumerate(sorted_list):
        li = document.createElement("li")
        li.innerHTML = f"{idx+1}. {item[1]}"
        resultsList.appendChild(li)
    update_progress("Tournament complete!")

# --- Button Event Handlers ---
async def fetch_handler(media_type):
    username = get_el("username").value.strip()
    if not username:
        update_progress("Please enter a username!")
        return
    update_progress("Fetching data; please wait...")
    items = await fetch_user_list(username, media_type)
    if not items:
        update_progress(f"No entries found for {media_type}.")
        return
    init_tournament(items)

def on_fetch_anime(event):
    asyncio.ensure_future(fetch_handler("ANIME"))

def on_fetch_manga(event):
    asyncio.ensure_future(fetch_handler("MANGA"))

def on_new_wins(event):
    handle_comparison(True)

def on_candidate_wins(event):
    handle_comparison(False)

# --- Bind DOM Events ---
get_el("fetchAnime").addEventListener("click", on_fetch_anime)
get_el("fetchManga").addEventListener("click", on_fetch_manga)
get_el("newWins").addEventListener("click", on_new_wins)
get_el("candidateWins").addEventListener("click", on_candidate_wins)
  </py-script>
</body>
</html>
